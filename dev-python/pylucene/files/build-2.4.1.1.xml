<project name="extensions" default="jar" basedir=".">

	<taskdef name="py-run" classname="org.pyant.tasks.PythonRunTask"/>

	<property name="build.dir" value="build" />
	<property name="dist.dir" value="${build.dir}/dist" />
	<property name="jar.dir" value="${build.dir}/jar" />
	<property name="src.dir" value="java" />
	<property name="docs.dir" value="docs" />
	<property name="jarfile" value="${dist.dir}/extensions.jar" />
	<property name="pkg" value="${package.name}"/>
	<property name="target.jdk" value="1.4" />

	<!-- init -->
	<target name="init">
		<tstamp/>
		<mkdir dir="${build.dir}" />
		<mkdir dir="${jar.dir}" />
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${docs.dir}"/>
	</target>
	
	<!-- compile the extensions part -->
	<target name="compile" depends="init">
		<javac
		srcdir="${src.dir}"
		destdir="${dist.dir}"
		source="${target.jdk}"
		target="${target.jdk}"
		classpath="${gentoo.classpath}" />
	</target>

	<!-- build the extensions.jar file -->
	<target name="jar" depends="compile">
		<jar destfile="${jarfile}" basedir="${dist.dir}" />
	</target>

	<!-- Build Python Module -->
	<macrodef name="generate">
		<attribute name="phase"/>
		<attribute name="root" default=""/>
		<attribute name="shared" default=""/>
		<sequential>
			<py-run script="${python.sitedir}/jcc/__init__.py" dir="." optimize="0">
				<arg line="--jar lib/lucene-core.jar"/>
				<arg line="--jar lib/lucene-analyzers.jar"/>
				<arg line="--jar lib/lucene-snowball.jar"/>
				<arg line="--jar lib/lucene-highlighter.jar"/>
				<arg line="--jar lib/lucene-regex.jar"/>
				<arg line="--jar lib/lucene-queries.jar"/>
				<arg line="--jar lib/lucene-instantiated.jar"/>
				<arg line="--jar ${jarfile}"/>
				<arg line="--package java.lang java.lang.System java.lang.Runtime"/>
				<arg line="--package java.util java.util.Arrays java.text.SimpleDateFormat"/>
				<arg line="--package java.io java.io.StringReader java.io.InputStreamReader java.io.FileInputStream"/>
				<arg line="--exclude org.apache.lucene.queryParser.Token"/>
				<arg line="--exclude org.apache.lucene.queryParser.TokenMgrError"/>
				<arg line="--exclude org.apache.lucene.queryParser.QueryParserTokenManager"/>
				<arg line="--exclude org.apache.lucene.queryParser.ParseException"/>
				<arg line="--python ${python.modname}"/>
				<arg line="--mapping org.apache.lucene.document.Document 'get:(Ljava/lang/String;)Ljava/lang/String;'"/>
				<arg line="--mapping java.util.Properties 'getProperty:(Ljava/lang/String;)Ljava/lang/String;'"/>
				<arg line="--sequence org.apache.lucene.search.Hits 'length:()I' 'doc:(I)Lorg/apache/lucene/document/Document;'"/>
				<arg line="--version ${lucene.pv}"/>
				<arg line="--module python/collections.py"/>
				<arg line="--files ${gentoo.numfiles}"/>
				<arg line="--classpath lib/jakarta-regexp.jar"/>
				<arg line="@{phase}"/>
				<arg line="@{root}"/>
				<arg line="@{shared}"/>
				<arg line="${gentoo.debug}"/>
			</py-run>
		</sequential>
	</macrodef>

	<target name="build">
		<!-- When setuptools has the shared patch add shared attribute here-->
		<generate phase="--build"/>
	</target>

	<target name="install">
		<generate phase="--install" root="--root ${gentoo.root}"/>
	</target>

	<!-- generate javadocs -->
	<target name="docs" depends="init">
		<javadoc sourcepath="${src.dir}"
			packagenames="org.*"
			destdir="${docs.dir}"
			classpath="${gentoo.classpath}"
			author="true"
			version="true"
			use="true"
			windowtitle="${ant.project.name} API" />
	</target>

	<target name="clean">
		<delete dir="${build.dir}"/>
		<delete dir="${jar.dir}"/>
	</target>

</project>
